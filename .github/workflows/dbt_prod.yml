name: dbt build (prod)

"on":
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  dbt:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      DBT_DATASET_PROD: ${{ secrets.DBT_DATASET_PROD }}
      DBT_LOCATION: ${{ secrets.DBT_LOCATION }}
      DBT_PROFILES_DIR: ${{ github.workspace }}/.dbt

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dbt
        run: |
          python -m pip install --upgrade pip
          pip install dbt-core dbt-bigquery

      - name: Write service account key
        run: |
          echo '${{ secrets.GCP_SA_KEY_JSON }}' > /tmp/sa.json

      - name: Write profiles.yml (prod)
        run: |
          mkdir -p "${DBT_PROFILES_DIR}"
          cat > "${DBT_PROFILES_DIR}/profiles.yml" << 'EOF'
          horseflex:
            target: prod
            outputs:
              prod:
                type: bigquery
                method: service-account
                project: "{{ env_var('GCP_PROJECT_ID') }}"
                dataset: "{{ env_var('DBT_DATASET_PROD') }}"
                location: "{{ env_var('DBT_LOCATION', 'EU') }}"
                keyfile: /tmp/sa.json
                threads: 4
                job_execution_timeout_seconds: 300
                job_retries: 1
          EOF

      - name: dbt deps
        run: dbt deps

      - name: dbt build (prod)
        run: dbt build --target prod